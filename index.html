<meta charset="utf-8">
<html>

<head>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://iwerts.github.io/xwing-miniatures-font/dist/xwing-miniatures.css">
    <link rel="stylesheet" href="assets/css/stylesheet.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        var iconsMap = returnJSON('https://iwerts.github.io/xwing-miniatures-font/src/json/icons-map.json');
        var shipsMap = returnJSON('https://iwerts.github.io/xwing-miniatures-font/src/json/ships-map.json');
        var quickBuilds = returnJSON('https://iwerts.github.io/xwsquickbuilds.json');


        $.getJSON('https://iwerts.github.io/xwing-data2/data/manifest.json', function (manifest) {
            $.getJSON('https://iwerts.github.io/xwing-data2/' + manifest.factions[0], function (factions) {
                $.each(factions, function (index, val) {
                    $("#faction").append('<option value="' + val.xws + '">' + val.name + '</option>');
                });
            });
        });
        
    function returnJSON(url){
        var http_request = new XMLHttpRequest();
        http_request.open("GET", url, false);
        http_request.send(null);
        return JSON.parse(http_request.responseText);
    }


    </script>
<script src="https://iwerts.github.io/assets/js/upgrades.js"></script>
<script>
console.log(astromechs);
</script>
    
</head>



<body>
    <form>
        <select id="faction">
            <option selected>Select Faction</option>
        </select>
        <select id="ship" disabled>
            <option selected>Select Ship</option>
        </select>
        <select id="pilot" disabled>
            <option selected>Select Pilot</option>
        </select>
        <br>
        <input type="checkbox" id="quick_build">
        <label id="quick_build_label">Quick Build?</label>
    </form>
   <div id="card">
    <div id="name_bar" class="card_field">
    </div>

    <div id="card_body" class="card_field">

    </div>

    <div id="card_footer" class="card_field">
    </div>
</div>
    <script>
        var current_faction;
        var current_ship;
        var current_pilot;

        $('#faction').change(function () {
            $('#ship_name').text('');
            $('#pilot_name').text('');
            $('#pilot_title').text('');

            $.getJSON('https://iwerts.github.io/xwing-data2/data/manifest.json', function (manifest) {

                for (var i = 0; i < manifest.pilots.length; i++) {
                    if ($("#faction option:selected").val() === manifest.pilots[i].faction) {
                        current_faction = manifest.pilots[i];
                        for (var j = 0; j < manifest.pilots[i].ships.length; j++) {

                            $("#ship").empty();
                            $("#ship").removeAttr("disabled");
                            $('#pilot').empty();
                            $('#pilot').prop("disabled", true);
                            $('#ship').append('<option selected>Select Ship</option>');
                            $('#pilot').append('<option selected>Select Pilot</option>');
                            $.getJSON('https://iwerts.github.io/xwing-data2/' + manifest.pilots[i].ships[j], function (ship) {
                                $("#ship").append('<option value="' + ship.xws + '">' + ship.name + '</option>');
                            });
                        }
                    }
                }
            });
        });
        $('#ship').change(function () {

            $.getJSON('https://iwerts.github.io/xwing-data2/data/manifest.json', function (manifest) {
                for (var i = 0; i < manifest.pilots.length; i++) {
                    if ($("#faction option:selected").val() === manifest.pilots[i].faction) {
                        for (var j = 0; j < manifest.pilots[i].ships.length; j++) {

                            $("#pilot").empty();

                            $("#pilot").removeAttr("disabled");
                            $.getJSON('https://iwerts.github.io/xwing-data2/' + manifest.pilots[i].ships[j], function (ship) {
                                if (ship.xws === $('#ship option:selected').val()) {
                                    current_ship = ship;
                                    $('#pilot').append('<option selected>Select Pilot</option>');
                                    for (var k = 0; k < ship.pilots.length; k++) {
                                        $("#pilot").append('<option value="' + ship.pilots[k].xws + '">' + ship.pilots[k].name + '</option>');
                                    }
                                }
                            });
                        }
                    }
                }
            });
        });

        $('#pilot').change(function () {

            for (var i = 0; i < current_ship.pilots.length; i++) {
                if (current_ship.pilots[i].xws === $('#pilot option:selected').val()) {
                    current_pilot = current_ship.pilots[i];
                }
            }
        });

        $('form').change(function () {
            $('.card_field').empty();
            
            if (current_pilot != null) {
                getNameBar();
                getCardBody();
                getCardFooter();
            if ($('#quick_build').prop('checked')){
                getQuickBuild();}
            }
        });

        function getNameBar() {
            getInitiative();
            getNameSection();
            getFactionIcon();
        }



        function getNameSection(){
            $('#name_bar').append('<span id="pilot_name_section"></span>')
            getName();
            getCaption();
        }

        function getCardBody() {
            getPilotInfo();
            getPilotActions();
        }

        function getPilotInfo(){
            $('#card_body').append('<span id="pilot_info"></span>');
            getPilotTextBox();
            getPilotStats();
        }

        function getCardFooter() {
            getShipIcon();
            getShipName();
        }

        function getPilotTextBox() {
            $('#pilot_info').append('<span id="pilot_text_box"></span>');

            getPilotAbility();
            getFlavorText();
            getShipAbility();
        }

        function getInitiative() {
            if (current_pilot.hasOwnProperty('initiative')) {
                $('#name_bar').append('<span id="pilot_initiative"></span>');
                $('#pilot_initiative').append(current_pilot.initiative);
            }
        }

        function getCaption() {
            if (current_pilot.hasOwnProperty('caption')) {
                $('#pilot_name_section').append('<span id="pilot_caption"></span>')
                $('#pilot_caption').append(current_pilot.caption);
            }
        }

        function getFactionIcon() {
            if (current_ship.hasOwnProperty('faction')) {
                $('#name_bar').append('<span id="faction_icon"></span>')
                $('#faction_icon').append(convertIcon(getFaction(current_ship.faction.toLowerCase().replace(/\s/g, ''))));
            }
        }

        function getPilotStats() {
            if (current_ship.hasOwnProperty('stats')) {
                $('#pilot_info').append('<hr><span id="pilot_stats"></span>');

                for (var i = 0; i < current_ship.stats.length; i++) {
                    getStat(current_ship.stats[i]);
                }
            }
            if (current_pilot.hasOwnProperty('charges')){
                value = current_pilot.charges.value;
                if (current_pilot.charges.hasOwnProperty('recovers')){
                    for (var i = 0; i < current_pilot.charges.recovers; i++){
                        value += '⯅';
                    }
                }
                $('#pilot_stats').append('<div class="pilot_stat"><span class="pilot_stat_icon">' + convertIcon('charge')+' </span><span class="pilot_stat_value">'+value + '</span></div>');
                
            }
            if (current_pilot.hasOwnProperty('force')){
                value = current_pilot.force.value;
                if (current_pilot.force.hasOwnProperty('recovers')){
                    for (var i = 0; i < current_pilot.force.recovers; i++){
                        value += '⯅';
                    }
                }
                $('#pilot_stats').append('<div class="pilot_stat"><span class="pilot_stat_icon">' + convertIcon('forcecharge')+' </span><span class="pilot_stat_value" id="force_stat_value">'+value + '</span></div>');
            }
        }


        function getPilotActions() {
            if (current_ship.hasOwnProperty('actions')) {
                $('#card_body').append('<span id="pilot_actions"></span>');

                for (var i = 0; i < current_ship.actions.length; i++) {
                    getAction(current_ship.actions[i]);
                }
            }
        }

        function getStat(stat) {
            switch(stat.type){
                case 'attack':
                    getAttack(stat);
                    break;
                    case 'charge':
                $('#pilot_stats').append('<div class="pilot_stat"><span class="pilot_stat_icon">' + convertIcon('charges')+' </span><span class="pilot_stat_value">'+stat.value + '</span></div>');
                break;
                case 'shields':
                $('#pilot_stats').append('<div class="pilot_stat"><span class="pilot_stat_icon">' + convertIcon('shield')+' </span><span class="pilot_stat_value">'+stat.value + '</span></div>');
                break;
                default: $('#pilot_stats').append('<div class="pilot_stat"><span class="pilot_stat_icon">' + convertIcon(stat.type.toLowerCase().replace(/\s/g, ''))+' </span><span class="pilot_stat_value">'+stat.value + '</span></div>');
            }
        }

        function getAction(action) {
            if (action.hasOwnProperty('linked')) {
                getLinkedAction(action);
            } else {
                $('#pilot_actions').append('<span class="pilot_action">' + convertIcon(action.type.toLowerCase().replace(/\s/g, ''), action.difficulty) + '</span>');
            }
        }

        function getLinkedAction(action) {
            $('#pilot_actions').append('<span class="pilot_action">' + convertIcon(action.type.toLowerCase().replace(/\s/g, ''), action.difficulty) + ' ' + convertIcon('linked', 'white') + ' ' + convertIcon(action.linked.type.toLowerCase().replace(/\s/g, ''), action.linked.difficulty) + '</span>');
        }

        function getAttack(attack) {
            if ($('#pilot_attack').length == 0){
                $('#pilot_stats').append('<div id="pilot_attack"></div>');
                getAttack(attack);
            } else {
                $('#pilot_attack').append('<div class="pilot_stat"><span class="pilot_stat_icon">' + convertIcon(attack.arc.toLowerCase().replace(/\s/g, ''))+' </span><span class="pilot_stat_value">'+attack.value + '</span></div>');
            }
        }

        function getShipIcon() {
            $('#card_footer').append('<span id="ship_icon"></span>');
            $('#ship_icon').append(convertShip(current_ship.xws));
        }

        function getShipName() {
            $('#card_footer').append('<span id="ship_name"></span>');
            $('#ship_name').append(current_ship.name);
        }

        function getShipAbility() {
            if (current_pilot.hasOwnProperty('shipAbility')) {
                $('#pilot_text_box').append('<span id="ship_ability"><span id="ship_ability_name"></span><span id="ship_ability_text"></span></span>');
                $('#ship_ability_name').append(current_pilot.shipAbility.name);
                $('#ship_ability_text').append(convertGameText(current_pilot.shipAbility.text));
            }
        }

        function getPilotAbility() {
            if (current_pilot.hasOwnProperty('ability')) {
                $('#pilot_text_box').append('<span id="pilot_ability"></span>');
                $('#pilot_ability').append(convertGameText(current_pilot.ability));
            }
        }
        function getFlavorText() {
            if (current_pilot.hasOwnProperty('text')) {
                $('#pilot_text_box').append('<div id="flavor_text"></span>');
                $('#flavor_text').append(convertGameText(current_pilot.text));
            }
        }

        function getActions() {
            for (var i = 0; i < current_ship.actions.length; i++) {
                if (current_ship.actions[i].hasOwnProperty('linked')) {
                    $('#action_bar').append('<div class="card_field">' + convertIcon((current_ship.actions[i].type).toLowerCase().replace(/\s/g, ''), current_ship.actions[i].difficulty) + ' ' + convertIcon('linked', 'black') + ' ' + convertIcon(current_ship.actions[i].linked.type.toString().toLowerCase().replace(/\s/g, ''), current_ship.actions[i].linked.difficulty));
                } else {
                    $('#action_bar').append('<div class="card_field">' + convertIcon((current_ship.actions[i].type).toLowerCase().replace(/\s/g, ''), current_ship.actions[i].difficulty) + '</div>');
                }
            }
        }

        

        function updateField(item, field) {
            if ((item).hasOwnProperty(field)) {
                return item[field];
            } else {
                return '';
            }
        }

        function getFaction(faction) {
            switch (faction) {
                case "scumandvillainy":
                    return "scum";
                case "rebelalliance":
                    return "rebel";
                case "galacticempire":
                    return "empire";
                case "resistance":
                    return "rebel";
                case "firstorder":
                    return "firstorder";
                case "galacticrepublic":
                    return "republic";
                case "separatistalliance":
                    return "separatists";
            }
        }

        function convertShip(iconSymbol) {
            return convertShip(iconSymbol, 'black');
        }

        function convertShip(iconSymbol, color) {
            if (color == null || color.toLowerCase() == 'white') {
                color = 'black';
            }
            console.log(shipsMap['ships'][iconSymbol]);
            return '<i class="xwing-miniatures-ship" style="color: ' + color + ';">' + shipsMap['ships'][iconSymbol] + '</i>';
        }

        function convertIcon(iconSymbol) {
            return convertIcon(iconSymbol, 'black');
        }

        function convertIcon(iconSymbol, color) {
            if (color == null || color.toLowerCase() == 'white') {
                color = 'black';
            }
             return '<i class="xwing-miniatures-font" style="color: ' + color + ';">' + iconsMap['icons'][iconSymbol] + '</i>';
            }

        function convertGameText(passedText) {
            ret = '';
            splitText = passedText.split(/\[[\w\s]*\]/g);
            textToConvert = passedText.match(/\[[\w\s]*\]/g);

            for (var i = 0; i < splitText.length; i++) {

                ret += splitText[i]
                if (textToConvert != null && textToConvert.length > i) {
                    ret += convertText(textToConvert[i].toLowerCase().replace(/\s/g, '').match(/\w+/)[0]);
                }
            }
            return ret;
        }

        function getName() {
            if (current_pilot.hasOwnProperty('name')) {

                $('#pilot_name_section').append('<span id="pilot_name"></span>');
                name = '';
                if (current_pilot.hasOwnProperty('limited')) {
                    if (current_pilot.limited > 0) {
                        for (var i = 0; i < current_pilot.limited; i++) {
                            name += '•';
                        }
                        name += ' ';
                    }
                }
                name += current_pilot.name;
                $('#pilot_name').append(name);
            }

        }

        function convertText(text) {
            console.log(text);
            if (text != null) {
                switch (text) {
                    case 'criticalhit':
                        return convertIcon('crit');
                    case 'force':
                        return convertIcon('forcecharge');
                    case 'koiogranturn':
                        return convertIcon('kturn');
                    case 'configuration':
                        return convertIcon('config');
                        case 'stationary':
                        return convertIcon('stop');
                    default:
                        return convertIcon(text.toString().replace(' ', '').toLowerCase());
                }
            }
        }
    </script>
</body>

</html>