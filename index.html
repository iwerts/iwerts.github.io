<html>

<head>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://iwerts.github.io/xwing-miniatures-font/dist/xwing-miniatures.css">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>      
        var iconsMap;
        var oReq = new XMLHttpRequest();
        oReq.onload = reqListener;
        oReq.open('GET', 'https://iwerts.github.io/xwing-miniatures-font/src/json/icons-map.json', true);
        oReq.send();
        
        function reqListener(e){
            iconsMap = JSON.parse(this.responseText);
        }
        
        $.getJSON('https://iwerts.github.io/xwing-data2/data/manifest.json', function(manifest){
            $.getJSON('https://iwerts.github.io/xwing-data2/'+manifest.factions[0], function(factions){
                $.each(factions, function(index, val){
                    $("#faction").append('<option value="'+val.xws+'">'+val.name+'</option>');
                }); 
            });
        });


    </script>
    
</head>



<body>
    <form>
    <select id="faction">
        <option selected>Select Faction</option>
    </select>
    <select id="ship" disabled>
        <option selected>Select Ship</option>
    </select>
    <select id="pilot" disabled>
        <option selected>Select Pilot</option>
    </select>
    </form>
    <div class="w3-card-4" style="max-width: 500px; max-height: 700px;">
        <div class="w3-display-container">
            <img src="https://via.placeholder.com/700x350.png" alt="pilot image" style="width:100%;" id="card_image" class="card_field">
            <div class="w3-xlarge w3-display-bottomleft w3-light-grey w3-opacity-min"><span id="pilot_name" class="card_field"></span>
            <br>
                <span id="pilot_title" class="w3-medium card_field" style="font-style: italic;"></span>
            </div>
            <div class="w3-xlarge w3-display-topleft w3-padding w3-light-grey w3-opacity-min">
                <span id="pilot_initiative" class="card_field"></span>
            </div>
            <div class="w3-xlarge w3-display-bottomright w3-padding w3-light-grey w3-opacity-min">
                <i id="pilot_faction" class="card_field xwing-miniatures-font" style="font-size: 48px;"></i>
            </div>
        </div>
        <div class="w3-container">
            <div id="ship_ability" class="w3-display-container w3-light-grey">
                <p id="ship_name" class="w3-center card_field"></p><br>
                <p id="ship_ability_name" class="card_field" style="font-weight: bold;"></p><br>
                <p id="ship_ability_text" class="card_field"></p>
            </div>
            <div id="pilot_ability" class="card_field"></div>
            <i id="flavor_text" class="card_field"></i>
            <hr>
            <div class="w3-panel" id="pilot_stats">

            </div>
        </div>
    </div>
   
    <script>
        var current_faction;
        var current_ship;
        var current_pilot;
        
        $('#faction').change(function(){
            $('#ship_name').text('');
            $('#pilot_name').text('');
            $('#pilot_title').text('');
            
            $.getJSON('https://iwerts.github.io/xwing-data2/data/manifest.json', function(manifest){
                
                for (var i = 0; i < manifest.pilots.length; i++){
                    if ($("#faction option:selected").val() === manifest.pilots[i].faction){
                        current_faction = manifest.pilots[i];
                        for (var j = 0; j < manifest.pilots[i].ships.length; j++){
                            
                            $("#ship").empty();
                            $("#ship").removeAttr("disabled");
                            $('#pilot').empty();               
                            $('#pilot').prop("disabled", true);
                            $('#ship').append('<option selected>Select Ship</option>');
                            $('#pilot').append('<option selected>Select Pilot</option>');
                            $.getJSON('https://iwerts.github.io/xwing-data2/'+manifest.pilots[i].ships[j], function(ship){
                                    $("#ship").append('<option value="'+ship.xws+'">'+ship.name+'</option>');
                                });
                        }
                    }
                }
            });
        });
        $('#ship').change(function(){
            
            $('#ship_name').text('');
            $('#pilot_name').text('');
            $('#pilot_title').text('');
              $.getJSON('https://iwerts.github.io/xwing-data2/data/manifest.json', function(manifest){
             for (var i = 0; i < manifest.pilots.length; i++){
                    if ($("#faction option:selected").val() === manifest.pilots[i].faction){
                        for (var j = 0; j < manifest.pilots[i].ships.length; j++){
                            
                            $("#pilot").empty();
                            
                            $("#pilot").removeAttr("disabled");
                            $.getJSON('https://iwerts.github.io/xwing-data2/'+manifest.pilots[i].ships[j], function(ship){
                                if (ship.xws === $('#ship option:selected').val()){
                                    current_ship = ship;
                                    $('#pilot').append('<option selected>Select Pilot</option>');
                                    for (var k = 0; k < ship.pilots.length; k++){
                                    $("#pilot").append('<option value="'+ship.pilots[k].xws+'">'+ship.pilots[k].name+'</option>');
                                }}
                            });
                        }
                    }
                }
        });
        });
        
        $('#pilot').change(function(){
            
            for (var i = 0; i < current_ship.pilots.length; i++){
                if (current_ship.pilots[i].xws === $('#pilot option:selected').val()){
                    current_pilot = current_ship.pilots[i];
                }
            }
        });
        
        $('form').change(function(){
            $('.card_field').empty();
            if (current_ship != null && current_faction != null && current_pilot != null){
            $('#ship_name').append(updateField(current_ship, 'name'));
            
            $('#card_image').attr('src', updateField(current_pilot, 'artwork'));

            $('#pilot_initiative').append(updateField(current_pilot, 'initiative'));
            $('#flavor_text').append(updateField(current_pilot, 'text'));
            $('#pilot_title').append(updateField(current_pilot, 'caption'));
            $('#pilot_name').append(getName());
            $('#pilot_ability').append(convertGameText(updateField(current_pilot, 'ability')));
        if (current_pilot.hasOwnProperty('shipAbility')){    
            $('#ship_ability_name').append(updateField(current_pilot, 'shipAbility').name);
            $('#ship_ability_text').append(convertGameText(updateField(current_pilot, 'shipAbility').text));
        
        }
            var val = convertIcon(getFaction(updateField(current_faction, 'faction')));
            $('#pilot_faction').append(val);
                    
            getActions();
            getStats();

            if (current_pilot.hasOwnProperty('force')){
                        $('#pilot_stats').append('<div class="w3-panel" id="pilot_force" style="text-align: center; color: purple;"></div>');
                        $('#pilot_force').append('<i class="xwing-miniatures-font">'+convertIcon('forcecharge')+'</i>');
                        $('#pilot_force').append('<br><span>'+current_pilot.force.value);
                        if (current_pilot.force.hasOwnProperty('recovers')){
                            for (var i = 0; i < current_pilot.force.recovers; i++){
                                $('#pilot_force').append('<i class="xwing-miniatures-font">'+convertIcon('recurring')+'</i>');        
                            }    
                        }
                        
                            $('#pilot_force').append('</span>');
                                

            }
            if (current_pilot.hasOwnProperty('charges')){
                        $('#pilot_stats').append('<div class="w3-panel" id="pilot_charges" style="text-align: center; color: orange;"></div>');
                        $('#pilot_charges').append('<i class="xwing-miniatures-font">'+convertIcon('charge')+'</i>');
                        $('#pilot_charges').append('<br><span>'+current_pilot.charges.value);
                        if (current_pilot.charges.hasOwnProperty('recovers')){
                            for (var i = 0; i < current_pilot.charges.recovers; i++){
                                $('#pilot_charges').append('<i class="xwing-miniatures-font">'+convertIcon('recurring')+'</i>');        
                            }    
                        }
                        
                            $('#pilot_charge').append('</span>');
                                

            }}
        });

        function getActions(){
            for (var i = 0; i < current_ship.actions.length; i++){
                if (current_ship.actions[i].hasOwnProperty('linked')){
                    $('#ship_ability').append('<div class="card_field">'+convertIcon((current_ship.actions[i].type).toLowerCase().replace(/\s/g, ''), current_ship.actions[i].difficulty) + ' '+convertIcon('linked', 'black')+' '+convertIcon(current_ship.actions[i].linked.type.toString().toLowerCase().replace(/\s/g, ''), current_ship.actions[i].linked.difficulty));
                } else {    
                        $('#ship_ability').append('<div class="card_field">'+convertIcon((current_ship.actions[i].type).toLowerCase().replace(/\s/g, ''), current_ship.actions[i].difficulty)+'</div>');
                }
            }
        }

        function getStats(){
            $('#pilot_stats').empty();
            stats = updateField(current_ship, 'stats');
            for (var i = 0; i < stats.length; i++){
                switch (stats[i].type){
                    case 'agility':
                        $('#pilot_stats').append('<div class="w3-panel" id="pilot_agility" style="text-align: center; color: lightgreen;"></div>');
                        $('#pilot_agility').append('<i class="xwing-miniatures-font">'+convertIcon('agility')+'</i>');
                        $('#pilot_agility').append('<br><span>'+stats[i].value+'</span>');
                        break;
                    case 'hull':
                        $('#pilot_stats').append('<div class="w3-panel" id="pilot_hull" style="text-align: center;color: yellow;"></div>');
                        $('#pilot_hull').append('<i class="xwing-miniatures-font">'+convertIcon('hull')+'</i>');
                        $('#pilot_hull').append('<br><span>'+stats[i].value+'</span>');
                        break;
                    case 'shields':
                        $('#pilot_stats').append('<div class="w3-panel" id="pilot_shield" style="text-align: center;color: lightblue;"></div>');
                        $('#pilot_shield').append('<i class="xwing-miniatures-font">'+convertIcon('shield')+'</i>');
                        $('#pilot_shield').append('<br><span>'+stats[i].value+'</span>');
                        break;   
                    case 'attack':
                              switch(stats[i].arc){
                                  case "Front Arc":
                                    $('#pilot_stats').append('<div class="w3-panel" id="pilot_front_arc" style="text-align: center;color: red;"></div>');
                                    $('#pilot_front_arc').append('<i class="xwing-miniatures-font">'+convertIcon('frontarc')+'</i>');
                                    $('#pilot_front_arc').append('<br><span>'+stats[i].value+'</span>');
                                    break;
                                case "Rear Arc":
                                    break;
                                    case "Single Turret Arc":
                                    break;
                              }
                    
                }
            }
        }
        
        function updateField(item, field){
            if ((item).hasOwnProperty(field)){
                return item[field];
            } else {
                return '';
            }
        }
        
        function getFaction(faction){
            switch (faction){
                case "scumandvillainy":
                    return "scum";
                case "rebelalliance":
                    return "rebel";
                case "galacticempire": 
                    return "empire";
                case "resistance":
                    return "rebel";
                case "firstorder":
                    return "firstorder";
                case "galacticrepublic":
                    return "republic";
                case "separatistalliance":
                    return "separatists";
            }
        }

        function convertIcon(iconSymbol){
            return convertIcon(iconSymbol, 'black');
        }

        function convertIcon(iconSymbol, color){
            if (color==null || color.toLowerCase() == 'white'){
                color = 'black';
            }
            return '<i class="xwing-miniatures-font" style="color: ' + color + ';">'+iconsMap['icons'][iconSymbol]+'</i>';
        }

        function convertGameText(passedText){
            ret = '';
            splitText = passedText.split(/\[[\w\s]*\]/g);
            textToConvert = passedText.match(/\[[\w\s]*\]/g);
            
            for (var i = 0; i < splitText.length; i++){

                ret += splitText[i]
                if (textToConvert != null && textToConvert.length > i){
                    ret += convertText(textToConvert[i].toLowerCase().replace(/\s/g,'').match(/\w+/)[0]);
            }}
            return ret;
        }

        function getName(){
            ret = '';
            for (var i = 0; i < updateField(current_pilot, 'limited'); i++){
                ret += '<i class="xwing-miniatures-font">'+convertIcon('unique')+'</i>';
            }

            if (updateField(current_pilot, 'limited')>0){
                ret += ' ';
            }

            ret += updateField(current_pilot, 'name');
            return ret;
        }

        function convertText(text){
            console.log(text);
            if (text != null){
            switch (text){
                case 'criticalhit':
                    return convertIcon('crit');
                case 'force':
                    return convertIcon('forcecharge');
                default:
                   return convertIcon(text.toString().replace(' ','').toLowerCase());
            }}
        }
    </script>
</body>
</html>
